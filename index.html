<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spice Village Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
  
  <!-- Load config file FIRST -->
  <script src="config.js"></script>
  
  <style>
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 1.5rem; }
    .tile { border-left-width: 4px; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-2xl font-bold text-gray-800">Spice Village Performance Dashboard</h1>
      <span class="text-sm text-gray-500">2025 Fiscal Year</span>
    </div>
    
    <!-- Loading State -->
    <div id="loading" class="text-center py-12">
      <div class="loading mx-auto mb-4"></div>
      <p class="text-gray-600">Loading dashboard data...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
      <h3 class="text-red-800 font-bold mb-2">Error Loading Dashboard</h3>
      <p id="error-message" class="text-red-600"></p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-content" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card tile border-blue-500">
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Online Sales (MTD)</p>
          <p id="online-mtd" class="text-2xl font-bold text-gray-800">â‚¬0</p>
          <p id="online-target" class="text-xs text-gray-500 mt-2"></p>
        </div>
        <div class="card tile border-green-500">
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Retail Sales (MTD)</p>
          <p id="retail-mtd" class="text-2xl font-bold text-gray-800">â‚¬0</p>
          <p id="retail-target" class="text-xs text-gray-500 mt-2"></p>
        </div>
        <div class="card tile border-yellow-500">
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Restaurant Sales (MTD)</p>
          <p id="rest-mtd" class="text-2xl font-bold text-gray-800">â‚¬0</p>
          <p id="rest-target" class="text-xs text-gray-500 mt-2"></p>
        </div>
        <div class="card tile border-purple-500">
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Net Profit (YTD)</p>
          <p id="profit-ytd" class="text-2xl font-bold text-gray-800">â‚¬0</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="card">
          <h3 class="font-bold mb-4">Sales per Channel</h3>
          <canvas id="salesChart"></canvas>
        </div>
        <div class="card">
          <h3 class="font-bold mb-4">GP % (Online & Retail)</h3>
          <canvas id="gpChart"></canvas>
        </div>
        <div class="card">
          <h3 class="font-bold mb-4">Purchase % of Sales</h3>
          <canvas id="purchaseChart"></canvas>
        </div>
        <div class="card">
          <h3 class="font-bold mb-4">Salary & Shipping %</h3>
          <canvas id="expenseChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIG is now loaded from config.js
    // Monthly Targets
    // ============================================
    const TARGETS = {
      online: 90000,
      retail: 45000,
      restaurant: 15000,
      total: 150000
    };

    // Helper to calculate if on track (based on days passed in month)
    function calculateProgress(actual, target) {
      const today = new Date();
      const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
      const daysPassed = today.getDate();
      const expectedProgress = (daysPassed / daysInMonth) * target;
      const percentage = (actual / target * 100).toFixed(0);
      
      let status = '';
      let color = '';
      if (actual >= expectedProgress * 1.05) {
        status = 'ðŸŸ¢ Ahead';
        color = '#10B981';
      } else if (actual >= expectedProgress * 0.95) {
        status = 'ðŸŸ¡ On Track';
        color = '#F59E0B';
      } else {
        status = 'ðŸ”´ Behind';
        color = '#EF4444';
      }
      
      return { percentage, status, color };
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function parseCurrency(str) {
      if (!str) return 0;
      const cleaned = str.toString().replace(/â‚¬|,|\s/g, '');
      return parseFloat(cleaned) || 0;
    }

    async function fetchSheetData(spreadsheetId, sheetName) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${CONFIG.apiKey}`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Failed to fetch ${sheetName}: ${response.statusText}`);
      }
      const data = await response.json();
      return data.values || [];
    }

    function findCurrentMonthRow(data, targetMonth = 11, targetYear = 2025) {
      for (let i = 0; i < data.length; i++) {
        if (!data[i][0]) continue;
        const date = new Date(data[i][0]);
        if (!isNaN(date.getTime()) && date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
          return i;
        }
      }
      return -1;
    }

    // ============================================
    // MAIN DATA FETCHING
    // ============================================
    
    async function getDashboardData() {
      try {
        const [sheetProData, sheetPurData, shopifyData, retailData, restaurantData] = await Promise.all([
          fetchSheetData(CONFIG.spreadsheetIdPro, 'Pro. Monthly'),
          fetchSheetData(CONFIG.spreadsheetIdPur, 'Dashboard'),
          fetchSheetData(CONFIG.spreadsheetIdPro, 'Shopify_Orders_Monthly'),
          fetchSheetData(CONFIG.spreadsheetIdPro, 'Retail Monthly Sales'),
          fetchSheetData(CONFIG.spreadsheetIdPro, 'Restaurant Monthly Sales')
        ]);

        const col = {
          month: 0, online: 2, retail: 3, rest: 4, onlineCOGS: 6, retailCOGS: 7, profit: 10, salary: 13, shipping: 14
        };

        let results = {
          mtd: { online: 0, retail: 0, restaurant: 0, profitYTD: 0 },
          charts: { labels: [], online: [], retail: [], rest: [], gpOnline: [], gpRetail: [], purchasePct: [], salaryPct: [], shippingPct: [] }
        };

        // MTD VALUES
        const shopifyRow = findCurrentMonthRow(shopifyData, 11, 2025);
        if (shopifyRow >= 0 && shopifyData[shopifyRow][5]) {
          results.mtd.online = parseCurrency(shopifyData[shopifyRow][5]);
        }

        const retailRow = findCurrentMonthRow(retailData, 11, 2025);
        if (retailRow >= 0 && retailData[retailRow][2]) {
          results.mtd.retail = parseCurrency(retailData[retailRow][2]);
        }

        const restaurantRow = findCurrentMonthRow(restaurantData, 11, 2025);
        if (restaurantRow >= 0) {
          const physical = parseCurrency(restaurantData[restaurantRow][2]);
          const wolt = parseCurrency(restaurantData[restaurantRow + 1]?.[2]);
          const uber = parseCurrency(restaurantData[restaurantRow + 2]?.[2]);
          results.mtd.restaurant = physical + wolt + uber;
        }

        sheetProData.slice(1).forEach(row => {
          const date = new Date(row[col.month]);
          if (!isNaN(date.getTime()) && date.getFullYear() === 2025 && row[col.profit]) {
            results.mtd.profitYTD += parseCurrency(row[col.profit]);
          }
        });

        // PURCHASE MAP
        let purchaseMap = {};
        sheetPurData.slice(4).forEach(row => {
          if (row[0]) {
            let d = new Date(row[0]);
            purchaseMap[d.getMonth()] = parseCurrency(row[1]);
          }
        });

        // HISTORICAL CHART DATA
        const proData = sheetProData.slice(1);
        proData.forEach(row => {
          let d = new Date(row[col.month]);
          if (d && d.getFullYear() === 2025 && row[col.online] !== "") {
            let monthLabel = d.toLocaleString('default', { month: 'short' });
            results.charts.labels.push(monthLabel);

            let sOnline = parseCurrency(row[col.online]);
            let sRetail = parseCurrency(row[col.retail]);
            let sRest = parseCurrency(row[col.rest]);
            let sTotal = sOnline + sRetail + sRest;

            results.charts.online.push(sOnline);
            results.charts.retail.push(sRetail);
            results.charts.rest.push(sRest);

            let onlineCOGS = parseCurrency(row[col.onlineCOGS]);
            let retailCOGS = parseCurrency(row[col.retailCOGS]);
            
            results.charts.gpOnline.push(sOnline > 0 ? (((sOnline - onlineCOGS) / sOnline) * 100).toFixed(1) : 0);
            results.charts.gpRetail.push(sRetail > 0 ? (((sRetail - retailCOGS) / sRetail) * 100).toFixed(1) : 0);

            let salary = parseCurrency(row[col.salary]);
            let shipping = parseCurrency(row[col.shipping]);
            
            results.charts.salaryPct.push(sTotal > 0 ? ((salary / sTotal) * 100).toFixed(1) : 0);
            results.charts.shippingPct.push(sOnline > 0 ? ((shipping / sOnline) * 100).toFixed(1) : 0);

            let pAmt = purchaseMap[d.getMonth()] || 0;
            results.charts.purchasePct.push(sTotal > 0 ? ((pAmt / sTotal) * 100).toFixed(1) : 0);
          }
        });

        return results;
      } catch (e) {
        return { error: e.toString() };
      }
    }

    // ============================================
    // DRAW FUNCTION
    // ============================================
    
    async function draw() {
      const data = await getDashboardData();
      
      document.getElementById('loading').classList.add('hidden');

      if (data.error) {
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error-message').innerText = data.error;
        return;
      }

      document.getElementById('dashboard-content').classList.remove('hidden');

      // Update MTD tiles with target indicators
      document.getElementById('online-mtd').innerText = 'â‚¬' + Number(data.mtd.online).toLocaleString();
      document.getElementById('retail-mtd').innerText = 'â‚¬' + Number(data.mtd.retail).toLocaleString();
      document.getElementById('rest-mtd').innerText = 'â‚¬' + Number(data.mtd.restaurant).toLocaleString();
      document.getElementById('profit-ytd').innerText = 'â‚¬' + Number(data.mtd.profitYTD).toLocaleString();

      // Add target progress
      const onlineProgress = calculateProgress(data.mtd.online, TARGETS.online);
      const retailProgress = calculateProgress(data.mtd.retail, TARGETS.retail);
      const restProgress = calculateProgress(data.mtd.restaurant, TARGETS.restaurant);
      
      document.getElementById('online-target').innerHTML = `Target: â‚¬${TARGETS.online.toLocaleString()} (${onlineProgress.percentage}%) <span style="color: ${onlineProgress.color}; font-weight: bold;">${onlineProgress.status}</span>`;
      document.getElementById('retail-target').innerHTML = `Target: â‚¬${TARGETS.retail.toLocaleString()} (${retailProgress.percentage}%) <span style="color: ${retailProgress.color}; font-weight: bold;">${retailProgress.status}</span>`;
      document.getElementById('rest-target').innerHTML = `Target: â‚¬${TARGETS.restaurant.toLocaleString()} (${restProgress.percentage}%) <span style="color: ${restProgress.color}; font-weight: bold;">${restProgress.status}</span>`;

      const commonOpts = { responsive: true, plugins: { legend: { position: 'bottom' } } };

      new Chart(document.getElementById('salesChart'), {
        type: 'bar',
        data: {
          labels: data.charts.labels,
          datasets: [
            { label: 'Online', data: data.charts.online, backgroundColor: '#3B82F6' },
            { label: 'Retail', data: data.charts.retail, backgroundColor: '#10B981' },
            { label: 'Rest', data: data.charts.rest, backgroundColor: '#F59E0B' }
          ]
        },
        options: { 
          ...commonOpts, 
          scales: { 
            x: { stacked: true }, 
            y: { 
              stacked: true, 
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'â‚¬' + value.toLocaleString();
                }
              }
            } 
          },
          plugins: {
            ...commonOpts.plugins,
            annotation: {
              annotations: {
                targetLine: {
                  type: 'line',
                  yMin: TARGETS.total,
                  yMax: TARGETS.total,
                  borderColor: '#EF4444',
                  borderWidth: 2,
                  borderDash: [10, 5],
                  label: {
                    content: 'Target: â‚¬' + TARGETS.total.toLocaleString(),
                    enabled: true,
                    position: 'end',
                    backgroundColor: '#EF4444',
                    color: 'white',
                    font: {
                      size: 10,
                      weight: 'bold'
                    }
                  }
                }
              }
            }
          }
        }
      });

      new Chart(document.getElementById('gpChart'), {
        type: 'line',
        data: {
          labels: data.charts.labels,
          datasets: [
            { label: 'Online GP%', data: data.charts.gpOnline, borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.3, fill: true, borderWidth: 2 },
            { label: 'Retail GP%', data: data.charts.gpRetail, borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.3, fill: true, borderWidth: 2 }
          ]
        },
        options: {
          ...commonOpts,
          scales: {
            y: {
              beginAtZero: true,
              max: 50,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });

      new Chart(document.getElementById('purchaseChart'), {
        type: 'line',
        data: {
          labels: data.charts.labels,
          datasets: [{ label: 'Purchase %', data: data.charts.purchasePct, borderColor: '#EF4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, borderWidth: 2, tension: 0.3 }]
        },
        options: {
          ...commonOpts,
          scales: {
            y: {
              beginAtZero: true,
              max: 70,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });

      new Chart(document.getElementById('expenseChart'), {
        type: 'line',
        data: {
          labels: data.charts.labels,
          datasets: [
            { label: 'Salary % (Total Sales)', data: data.charts.salaryPct, borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.3, borderWidth: 2 },
            { label: 'Shipping % (Online Only)', data: data.charts.shippingPct, borderColor: '#6366F1', backgroundColor: 'rgba(99, 102, 241, 0.1)', tension: 0.3, borderWidth: 2 }
          ]
        },
        options: {
          ...commonOpts,
          scales: {
            y: {
              beginAtZero: true,
              max: 25,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }

    draw();
  </script>
</body>
</html>